# üíß Zaino Web - Fluj√≥metro de Agua en Tiempo Real

![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)
![Flask](https://img.shields.io/badge/Flask-2.0+-green.svg)
![Bootstrap](https://img.shields.io/badge/Bootstrap-5.3-purple.svg)
![jQuery](https://img.shields.io/badge/jQuery-3.6-blue.svg)
![Arduino IoT](https://img.shields.io/badge/Arduino-IoT%20Cloud-00979D.svg)
![PDF Export](https://img.shields.io/badge/PDF-Export-red.svg)
![License](https://img.shields.io/badge/License-MIT-yellow.svg)

## üìã Descripci√≥n

**Zaino Web** es una aplicaci√≥n web desarrollada en colaboraci√≥n con el **Instituto Profesional AIEP** para una comunidad que necesitaba monitorear en tiempo real el caudal de agua de un r√≠o. La soluci√≥n integra hardware IoT con Arduino, sensores de flujo, y una interfaz web moderna desarrollada con Python Flask, permitiendo visualizar datos en tiempo real, estad√≠sticas hist√≥ricas y generar informes.

Este proyecto combina tecnolog√≠as de IoT, backend con Flask, y un frontend responsive para ofrecer una experiencia completa de monitoreo h√≠drico.

---

## üéâ Novedades v1.1.0

### üìÑ Sistema de Informes Completo
- ‚úÖ **Generaci√≥n mensual autom√°tica** con validaci√≥n de duplicados
- ‚úÖ **Exportaci√≥n a PDF profesional** del lado del cliente (sin carga en servidor)
- ‚úÖ **Tres formatos de exportaci√≥n**: Ver en navegador, descargar JSON, exportar PDF
- ‚úÖ **Dise√±o optimizado** para impresi√≥n en formato A4
- ‚úÖ **Validaci√≥n inteligente**: Un informe por mes con c√°lculo autom√°tico de d√≠as del per√≠odo
- ‚úÖ **Feedback visual completo**: Toasts, spinners, modales con estado de carga
- ‚úÖ **Botones de acci√≥n directa**: Exportar sin abrir el modal

### üîß Mejoras T√©cnicas
- ‚úÖ **Bootstrap JS completo**: Modales y componentes interactivos funcionales
- ‚úÖ **html2canvas + jsPDF**: Generaci√≥n de PDFs de alta calidad en el cliente
- ‚úÖ **Sistema de notificaciones**: Toasts con auto-cleanup
- ‚úÖ **Modales reutilizables**: Sin duplicaci√≥n en el DOM
- ‚úÖ **Validaciones robustas**: Manejo completo de errores con restauraci√≥n de UI

---

## ‚ú® Caracter√≠sticas Principales

### üåä Monitoreo en Tiempo Real
- **Flujo instant√°neo** (L/min) con medidor visual tipo gauge
- **Flujo acumulado** total de litros
- **Gr√°fico hist√≥rico** de los √∫ltimos 5 minutos
- **Actualizaci√≥n autom√°tica** cada 10 segundos
- **Estad√≠sticas en vivo**: m√°ximo, m√≠nimo y promedio

### üå§Ô∏è Datos Meteorol√≥gicos
- Integraci√≥n con **Weathercloud API**
- Temperatura y sensaci√≥n t√©rmica
- Presi√≥n atmosf√©rica
- Indicadores visuales del clima

### üìä Panel de Control
- **Dashboard intuitivo** con m√©tricas clave
- **Vista responsive** para m√≥viles, tablets y desktop
- **Sistema de cach√©** para optimizar peticiones
- **Sistema de informes completo**:
  - Generaci√≥n de informes mensuales autom√°ticos
  - Validaci√≥n de duplicados (un informe por mes)
  - Descarga en formato JSON
  - **Exportaci√≥n a PDF** con dise√±o profesional
  - Visualizaci√≥n detallada con estad√≠sticas e iconos
  - Almacenamiento autom√°tico en sistema de archivos
  - Gesti√≥n completa (crear, ver, descargar PDF/JSON, eliminar)
  - Botones de acci√≥n directa desde la lista
  - Feedback visual con toasts y spinners

### üé® Interfaz Moderna
- Dise√±o **Material Design** con gradientes
- **Animaciones suaves** y transiciones
- **Modo oscuro** en men√∫ lateral
- **Iconos Bootstrap** para mejor UX
- **Modales interactivos** con validaciones
- **Sistema de notificaciones** (Toasts) con feedback visual

### üìÑ Exportaci√≥n de Informes
- **Exportaci√≥n a PDF profesional** del lado del cliente
- Dise√±o optimizado para impresi√≥n (formato A4)
- Conversi√≥n HTML‚ÜíCanvas‚ÜíPDF con alta calidad
- Paginaci√≥n autom√°tica para contenido extenso
- Header personalizado con logo y fecha de generaci√≥n
- Footer con informaci√≥n institucional
- Tres formas de exportar:
  - Desde modal de visualizaci√≥n
  - Directamente desde la lista (desktop)
  - Desde cards m√≥viles
- Sin necesidad de procesamiento en el servidor

---

## üõ†Ô∏è Tecnolog√≠as Utilizadas

### Backend
- **Python 3.8+**
- **Flask 2.0+** - Framework web
- **Requests** - Cliente HTTP
- **OAuth2Session** - Autenticaci√≥n con Arduino IoT Cloud
- **Python-dotenv** - Gesti√≥n de variables de entorno

### Frontend
- **HTML5 / CSS3**
- **JavaScript (ES6+)**
- **jQuery 3.6**
- **Bootstrap 5.3** - Framework CSS completo con JavaScript
- **Bootstrap Icons** - Iconograf√≠a vectorial
- **SVG** - Gr√°ficos vectoriales para visualizaciones
- **html2canvas 1.4.1** - Conversi√≥n de HTML a imagen para PDFs
- **jsPDF 2.5.1** - Generaci√≥n de archivos PDF del lado del cliente

### APIs Integradas
- **Arduino IoT Cloud API** - Obtenci√≥n de datos del fluj√≥metro (API oficial)
- **Weathercloud API** - Datos meteorol√≥gicos en tiempo real (‚ö†Ô∏è Ingenier√≠a inversa - no oficial)

> **Nota t√©cnica**: La integraci√≥n con Weathercloud fue implementada mediante ingenier√≠a inversa, ya que no existe una API p√∫blica oficial. Ver secci√≥n de Caracter√≠sticas T√©cnicas para m√°s detalles.

### IoT Hardware
- **Arduino** con conectividad IoT
- **Sensores de flujo** para medici√≥n de caudal
- **Comunicaci√≥n en tiempo real** con Arduino IoT Cloud

---

## üìÅ Estructura del Proyecto

```
zaino-web/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api_controller.py      # Endpoints de la API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app_controller.py      # Controladores de vistas
‚îÇ   ‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.css            # Estilos principales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.js             # L√≥gica principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ debug.js           # Herramientas de debug
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ img/                   # Im√°genes y recursos
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.html               # Template principal
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ config.py              # Configuraci√≥n
‚îÇ       ‚îî‚îÄ‚îÄ weathercloud_py.py     # Cliente Weathercloud
‚îÇ
‚îú‚îÄ‚îÄ informes/                      # Informes generados (creado autom√°ticamente)
‚îú‚îÄ‚îÄ .env                           # Variables de entorno (no incluido)
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ app.py                         # Punto de entrada
‚îú‚îÄ‚îÄ Pipfile                        # Dependencias Pipenv
‚îú‚îÄ‚îÄ requirements.txt               # Dependencias pip
‚îú‚îÄ‚îÄ visitas.json                   # Contador de visitas
‚îî‚îÄ‚îÄ README.md
```

---

## ‚öôÔ∏è Configuraci√≥n

### 1. Variables de Entorno (`.env`)

Crea un archivo `.env` en la ra√≠z del proyecto con las siguientes variables:

```env
# Arduino IoT Cloud Credentials
CLIENT_ID=tu_client_id_de_arduino
CLIENT_SECRET=tu_client_secret_de_arduino

# Weathercloud API Credentials
WEATHERCLOUD_EMAIL=tu_email@example.com
WEATHERCLOUD_PASSWORD=tu_password_weathercloud

# Configuraci√≥n de estaci√≥n meteorol√≥gica
WEATHERCLOUD_DEVICEID=ID_DE_TU_ESTACION

# Flask Security - Clave secreta (IMPORTANTE EN PRODUCCI√ìN)
# Genera una con: python -c "import os; print(os.urandom(24).hex())"
SECRET_KEY=tu_clave_secreta_aleatoria_aqui
```

> **Nota de Seguridad**: Si no especificas una `SECRET_KEY`, la aplicaci√≥n generar√° una aleatoria autom√°ticamente. Sin embargo, esto har√° que las sesiones se invaliden cada vez que reinicies el servidor. Para producci√≥n, **siempre configura una SECRET_KEY fija**.

### 2. Obtener Credenciales

#### Arduino IoT Cloud
1. Crea una cuenta en [Arduino IoT Cloud](https://cloud.arduino.cc/)
2. Ve a **API Keys** en tu panel
3. Crea un nuevo **Client ID** y **Client Secret**
4. Configura un **Thing** llamado "Medidor de Flujo" con propiedades:
   - `constflow` (float): Flujo instant√°neo en L/min
   - `instflow` (float): Flujo acumulado en Litros

#### Weathercloud
1. Reg√≠strate en [Weathercloud](https://weathercloud.net/)
2. Obt√©n el ID de tu estaci√≥n meteorol√≥gica
3. Usa tus credenciales de login

> **‚ö†Ô∏è Nota Importante sobre Weathercloud API**  
> Weathercloud no proporciona una API p√∫blica oficial documentada. Este proyecto utiliza **ingenier√≠a inversa** de las peticiones HTTP realizadas por su sitio web para acceder a los datos meteorol√≥gicos. La implementaci√≥n se encuentra en `app/utils/weathercloud_py.py` y simula el comportamiento de autenticaci√≥n del navegador.
> 
> **Implicaciones:**
> - ‚úÖ Funcional y probado
> - ‚ö†Ô∏è Puede cambiar sin previo aviso si Weathercloud modifica su sitio
> - üìù Uso bajo tu propia responsabilidad
> - üîê Mant√©n tus credenciales seguras en el `.env`
> 
> Si Weathercloud lanza una API oficial en el futuro, se recomienda migrar a ella.

---

## üöÄ Instalaci√≥n

### Prerequisitos
- Python 3.8 o superior
- pip o pipenv
- Git

### Opci√≥n 1: Usando Pipenv (Recomendado)

```bash
# Clonar el repositorio
git clone https://github.com/tu-usuario/zaino-web.git
cd zaino-web

# Instalar pipenv si no lo tienes
pip install pipenv

# Instalar dependencias
pipenv install

# Activar el entorno virtual
pipenv shell

# Crear archivo .env y configurar variables
cp .env.example .env
# Edita el archivo .env con tus credenciales

# Ejecutar la aplicaci√≥n
python app.py
```

### Opci√≥n 2: Usando pip

```bash
# Clonar el repositorio
git clone https://github.com/tu-usuario/zaino-web.git
cd zaino-web

# Crear entorno virtual
python -m venv venv

# Activar entorno virtual
# En Windows:
venv\Scripts\activate
# En Linux/Mac:
source venv/bin/activate

# Instalar dependencias
pip install -r requirements.txt

# Crear archivo .env y configurar variables
cp .env.example .env
# Edita el archivo .env con tus credenciales

# Ejecutar la aplicaci√≥n
python app.py
```

La aplicaci√≥n estar√° disponible en: `http://localhost:5000`

---

## üåê Despliegue

### URL Oficial
üîó **Producci√≥n**: [https://aguaconecta.cl](https://aguaconecta.cl)  
üîó **Demo**: [https://aguaconecta.urrahost.app](https://aguaconecta.urrahost.app)

### Despliegue en Producci√≥n

#### Usando Docker üê≥

**1. Crear archivo `Dockerfile`**
```dockerfile
# Use official Python base image
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install curl
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Copy dependency files
COPY requirements.txt ./

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the application
COPY . .

# Expose port
EXPOSE 5000

# Command to run the app
CMD ["python", "app.py"]
```
#### Flask nativo (Solo desarrollo/pruebas)

> **‚ö†Ô∏è ADVERTENCIA**: Flask nativo NO es recomendado para producci√≥n. Usa Docker en su lugar.

**Ejecuci√≥n directa**
```bash
# Configurar modo producci√≥n
export FLASK_ENV=production  # Linux/Mac
$env:FLASK_ENV="production"  # Windows PowerShell

# Ejecutar
python app.py
```

---

## üìä API Endpoints

### Fluj√≥metro
- `GET /api/arduino/flowmeter` - Obtiene datos del fluj√≥metro con cach√© de 8s
- `GET /api/test-api` - Prueba conexi√≥n con Arduino IoT Cloud

### Informes
- `GET /api/informes` - Lista todos los informes disponibles con metadata
- `POST /api/informes/generar` - Genera un nuevo informe mensual
  ```json
  {
    "periodo": "ultimo_mes"  // Solo mensual permitido
  }
  ```
  **Validaciones**:
  - Solo un informe por mes
  - Calcula d√≠as transcurridos vs d√≠as del mes (28-31)
  - Retorna error si ya existe informe del mes actual
  
- `GET /api/informes/<informe_id>` - Obtiene un informe espec√≠fico con todos sus datos
- `DELETE /api/informes/<informe_id>` - Elimina un informe del sistema

### Clima
- `GET /api/weather` - Datos de estaci√≥n por defecto
- `GET /api/weather/<station_id>` - Datos de estaci√≥n espec√≠fica
- `GET /api/weather/nearest?lat={lat}&lon={lon}&radius={radius}` - Estaciones cercanas
- `GET /api/weather/profile/<station_id>` - Perfil de estaci√≥n
- `GET /api/weather/statistics/<station_id>` - Estad√≠sticas de estaci√≥n

### Utilidades
- `POST /api/visitas` - Incrementa contador de visitas

---

## üéØ Caracter√≠sticas T√©cnicas

### Sistema de Cach√©
- **TTL**: 8 segundos para datos del fluj√≥metro
- **Reducci√≥n**: ~95% menos peticiones a Arduino IoT Cloud
- **Fallback autom√°tico** en caso de rate limiting (429)

### Sistema de Informes
- **Validaci√≥n inteligente**: Un informe por mes con c√°lculo de d√≠as restantes
- **Almacenamiento**: Sistema de archivos (JSON) con metadata completa
- **Exportaci√≥n m√∫ltiple**: JSON para datos raw, PDF para presentaci√≥n
- **Generaci√≥n cliente**: PDFs generados en el navegador sin carga en servidor
- **Calidad profesional**: Dise√±o A4 optimizado para impresi√≥n

### Exportaci√≥n a PDF
- **Librer√≠a html2canvas**: Convierte HTML renderizado a imagen de alta calidad (scale 2x)
- **Librer√≠a jsPDF**: Genera PDFs del lado del cliente con paginaci√≥n autom√°tica
- **Sin backend**: Procesamiento 100% en el navegador del usuario
- **Dise√±o consistente**: Mantiene el estilo visual de la interfaz web
- **Optimizado para impresi√≥n**: Formato A4 (210x297mm) con m√°rgenes apropiados

### Responsive Design
- **Mobile-first** approach
- **Breakpoints**: 480px, 768px, 1024px
- **Adaptaci√≥n autom√°tica** de layout en tablets y m√≥viles
- **Touch-friendly** para dispositivos t√°ctiles
- **Cards adaptativas**: Vista de tabla en desktop, cards en m√≥vil

### Optimizaciones
- **Lazy loading** de datos
- **Debouncing** en resize events (250ms)
- **Peticiones controladas** para evitar rate limiting
- **Animaciones con CSS** para mejor rendimiento
- **Toasts con auto-cleanup**: Notificaciones que se eliminan autom√°ticamente
- **Modales reutilizables**: No se duplican en el DOM

### Integraci√≥n con APIs Privadas (Ingenier√≠a Inversa)

Este proyecto incluye un cliente personalizado para **Weathercloud** (`weathercloud_py.py`) que fue desarrollado mediante ingenier√≠a inversa de las peticiones HTTP del sitio web oficial.

**Proceso de Ingenier√≠a Inversa:**
1. **An√°lisis de tr√°fico**: Interceptaci√≥n de peticiones con DevTools del navegador
2. **Simulaci√≥n de autenticaci√≥n**: Replicaci√≥n del flujo de login con cookies y headers
3. **Endpoints descubiertos**:
   - `/api/weather` - Datos actuales de una estaci√≥n
   - `/api/weather/nearest` - Estaciones cercanas por coordenadas
   - `/api/weather/profile` - Perfil de estaci√≥n
   - `/api/weather/statistics` - Estad√≠sticas hist√≥ricas

**Implementaci√≥n t√©cnica:**
```python
# Simula el comportamiento del navegador
session = requests.Session()
headers = {
    'User-Agent': 'Mozilla/5.0...',
    'Accept': 'application/json',
    'Referer': 'https://weathercloud.net/'
}
# Autenticaci√≥n y obtenci√≥n de tokens de sesi√≥n
```

**Mantenimiento:**
- El c√≥digo puede necesitar actualizaciones si Weathercloud cambia su estructura
- Se recomienda revisar peri√≥dicamente el funcionamiento
- Considerar alternativas con APIs oficiales cuando est√©n disponibles

### Arquitectura del Sistema de Informes

#### Flujo de Generaci√≥n
1. **Validaci√≥n**: Sistema verifica que no exista informe del mes actual
2. **C√°lculo de per√≠odo**: Del primer d√≠a del mes anterior hasta hoy
3. **Obtenci√≥n de datos**: Lee desde cach√© del fluj√≥metro (8s TTL)
4. **C√°lculo de estad√≠sticas**: 
   - Flujo instant√°neo (L/min)
   - Flujo acumulado (Litros)
   - Promedio diario (basado en d√≠as reales del per√≠odo)
5. **Almacenamiento**: Guarda JSON con timestamp √∫nico
6. **Feedback**: Notifica al usuario y recarga la lista

#### Exportaci√≥n PDF
```
HTML (Modal) ‚Üí html2canvas ‚Üí Canvas (PNG) ‚Üí jsPDF ‚Üí PDF (A4)
```

**Proceso:**
1. Crea contenedor temporal con dise√±o optimizado (210mm x 297mm)
2. Aplica estilos inline para consistencia
3. Convierte a canvas de alta resoluci√≥n (scale 2x)
4. Genera PDF con paginaci√≥n autom√°tica
5. Limpia recursos y descarga archivo

**Ventajas:**
- ‚úÖ Sin carga en servidor
- ‚úÖ Funciona offline (una vez cargada la p√°gina)
- ‚úÖ Inmediato (no espera cola de procesamiento)
- ‚úÖ Personalizable (estilos ajustables en c√≥digo)

---

## ü§ù Contribuir

Las contribuciones son bienvenidas. Para contribuir:

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

---

## üìù Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para m√°s detalles.

---

## üë• Autores

- **Desarrollo**: En colaboraci√≥n con Instituto Profesional AIEP 
- **Comunidad**: Proyecto desarrollado para monitoreo comunitario de recursos h√≠dricos

---

## üìß Contacto

Para preguntas, sugerencias o reportar problemas:

- **Issues**: [GitHub Issues](https://github.com/IdkBemja/zaino-web/issues)
- **Email**: contact@urrahost.app (Asunto: "Sugerencia/Pregunta/Problemas Zaino Web")

---

## üôè Agradecimientos

- Instituto Profesional AIEP por el apoyo en el desarrollo
- Arduino IoT Cloud por proporcionar la infraestructura IoT
- Weathercloud por los datos meteorol√≥gicos
- [Maxime-mrl](https://github.com/maxime-mrl/weathercloud-js/tree/main) Por hacer ingenieria inversa a la api privada de Weathercloud para JS (Se adapto para python gracias a este).
- La comunidad que inspir√≥ este proyecto

---

## üì∏ Capturas de Pantalla

### Dashboard Principal
![Dashboard](docs/screenshots/dashboard.png)
*Panel principal con medidor de flujo en tiempo real, datos meteorol√≥gicos y contador de visitas*

### Vista M√≥vil
![Mobile](docs/screenshots/mobile.png)
*Dise√±o responsive adaptado para dispositivos m√≥viles con cards y botones touch-friendly*

### Monitoreo en Tiempo Real
![Real-time](docs/screenshots/realtime.png)
*Gr√°fico de flujo en tiempo real con historial de 5 minutos y estad√≠sticas*

### Sistema de Informes
![Reports](docs/screenshots/informes.png)
*Lista de informes mensuales con opciones de exportaci√≥n PDF, descarga JSON y visualizaci√≥n*

### Visualizaci√≥n de Informe
![Report View](docs/screenshots/informe-detalle.png)
*Modal con estad√≠sticas detalladas, gr√°ficos y datos del fluj√≥metro*

### Exportaci√≥n a PDF
![PDF Export](docs/screenshots/pdf-export.png)
*Documento PDF generado con dise√±o profesional listo para imprimir*

---

**Zaino Web** - Monitoreo inteligente de recursos h√≠dricos üíß